@router.post("/projects/{project_id}/landscape", response_model=TaskResponse)
def start_landscape_analysis(
    project_id: int,
    current_user: models.User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """启动研究脉络分析任务（使用Celery）"""
    # 验证项目所有权
    project = db.query(models.ResearchProject).filter(
        models.ResearchProject.id == project_id,
        models.ResearchProject.user_id == current_user.id
    ).first()
    
    if not project:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Project not found"
        )
    
    # 检查是否已有文献分析
    analyses_count = db.query(models.PaperAnalysisDB).filter(
        models.PaperAnalysisDB.project_id == project_id
    ).count()
    
    if analyses_count == 0:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="No paper analyses found. Please run paper analysis first."
        )
    
    # 提交Celery任务
    from backend.tasks.analysis import landscape_analysis_task
    
    celery_result = landscape_analysis_task.delay(project_id)
    
    # 创建任务记录
    task = models.AsyncTask(
        project_id=project_id,
        user_id=current_user.id,
        task_id=celery_result.id,
        task_name="Research Landscape Analysis",
        task_type="landscape",
        status=models.TaskStatus.PENDING,
        progress=0
    )
    
    db.add(task)
    db.commit()
    db.refresh(task)
    
    return task


@router.post("/projects/{project_id}/ideas", response_model=TaskResponse)
def start_idea_generation(
    project_id: int,
    num_ideas: int = 5,
    current_user: models.User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """启动研究想法生成任务（使用Celery）"""
    # 验证项目所有权
    project = db.query(models.ResearchProject).filter(
        models.ResearchProject.id == project_id,
        models.ResearchProject.user_id == current_user.id
    ).first()
    
    if not project:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Project not found"
        )
    
    # 检查是否已有脉络分析
    landscape = db.query(models.ResearchLandscapeDB).filter(
        models.ResearchLandscapeDB.project_id == project_id
    ).first()
    
    if not landscape:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="No research landscape found. Please run landscape analysis first."
        )
    
    # 提交Celery任务
    from backend.tasks.generation import idea_generation_task
    
    celery_result = idea_generation_task.delay(project_id, num_ideas)
    
    # 创建任务记录
    task = models.AsyncTask(
        project_id=project_id,
        user_id=current_user.id,
        task_id=celery_result.id,
        task_name="Research Idea Generation",
        task_type="ideas",
        status=models.TaskStatus.PENDING,
        progress=0
    )
    
    db.add(task)
    db.commit()
    db.refresh(task)
    
    return task
